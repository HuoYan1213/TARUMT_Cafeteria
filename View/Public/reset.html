<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../CSS/public.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="shortcut icon" href="../../Icon/logo.png">
    <title>Reset Password...</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../JS/script.js"></script>
</head>
<body>
    <section>
        <img src="../../Icon/logo.png">
        <h1>Reset Password</h1>
        <form id="reset-form" class="login-card">
            <!-- Stage 1: Enter Email -->
            <div id="stage-1" class="login-group">
                <div class="login-items">
                    <label for="email-input"><i class="fa-solid fa-envelope"></i></label>
                    <input id="email-input" type="email" placeholder="Please enter your registered email..." name="email" required>
                </div>
            </div>

            <!-- Stage 2: Enter OTP and New Password -->
            <div id="stage-2" class="login-group" style="display: none;">
                <div class="login-items">
                    <label for="otp-input"><i class="fa-solid fa-shield-halved"></i></label>
                    <input id="otp-input" type="text" placeholder="Enter OTP..." name="otp">
                </div>
                <div class="login-items">
                    <label for="password-input"><i class="fa-solid fa-key"></i></label>
                    <input id="password-input" type="password" placeholder="New Password..." name="password">
                </div>
                <div class="login-items">
                    <label for="confirm-password-input"><i class="fa-solid fa-check-double"></i></label>
                    <input id="confirm-password-input" type="password" placeholder="Confirm New Password..." name="confirm_password">
                </div>
            </div>

            <div class="submit-form">
                <button type="submit" id="reset-button">Send OTP</button>
                <span>Remember your password? <a href="login.html">Login</a></span>
            </div>
        </form>
    </section>

    <script>
        $(document).ready(function() {
            let currentStage = 1;
            
            // Initially, only email is required
            $('#otp-input, #password-input, #confirm-password-input').prop('required', false);
            $('#email-input').prop('required', true);


            $('#reset-form').on('submit', function(e) {
                e.preventDefault();
                const $button = $('#reset-button');

                if (currentStage === 1) {
                    // --- Handle Stage 1: Request OTP ---
                    const email = $('#email-input').val();
                    $button.text('Sending...').prop('disabled', true);

                    $.ajax({
                        url: '../../Controller/PublicController.php',
                        type: 'POST',
                        dataType: 'json',
                        data: { action: 'request_otp', email: email },
                        success: function(response) {
                            if (response.status === 'success') {
                                displayToast(response.message, "success");
                                
                                // Transition to Stage 2
                                $('#stage-1').hide();
                                $('#email-input').prop('required', false); // Email is no longer required for validation

                                $('#stage-2').show();
                                $('#otp-input, #password-input, #confirm-password-input').prop('required', true); // Now these are required

                                $button.text('Reset Password').prop('disabled', false);
                                currentStage = 2;
                            } else {
                                displayToast(response.message, "error");
                                $button.text('Send OTP').prop('disabled', false);
                            }
                        },
                        error: function() {
                            displayToast("Server Error. Please Try Again.", "error");
                            $button.text('Send OTP').prop('disabled', false);
                        }
                    });

                } else if (currentStage === 2) {
                    // --- Handle Stage 2: Reset Password ---
                    const email = $('#email-input').val(); // Email is still needed
                    const otp = $('#otp-input').val();
                    const password = $('#password-input').val();
                    const confirmPassword = $('#confirm-password-input').val();

                    if (password !== confirmPassword) {
                        displayToast("Passwords do not match!", "error");
                        return;
                    }

                    $button.text('Resetting...').prop('disabled', true);

                    $.ajax({
                        url: '../../Controller/PublicController.php',
                        type: 'POST',
                        dataType: 'json',
                        data: { action: 'reset_password', email: email, otp: otp, password: password },
                        success: function(response) {
                            if (response.status === 'success') {
                                displayToast("Password reset successfully! Redirecting to login...", "success");
                                setTimeout(() => {
                                    window.location.href = 'login.html';
                                }, 2000);
                            } else {
                                displayToast(response.message, "error");
                                $button.text('Reset Password').prop('disabled', false);
                            }
                        },
                        error: function() {
                            displayToast("Server Error. Please Try Again.", "error");
                            $button.text('Reset Password').prop('disabled', false);
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>