<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Payment</title>
    <link rel="shortcut icon" href="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background: #FFFFFF;
            height: 100vh;
            width: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            font-family: Arial, Helvetica, sans-serif;
        }

        main {
            box-sizing: border-box;
            height: 100vh;
            width: 100%;
            max-width: 414px;
            box-shadow: 0 0 10px #00000080;
        }

        header {
            background: #0047BA;
            color: #FFFFFF;
            font-weight: 600;
            font-size: 16px;
            padding: 15px 0;
            text-align: center;
        }

        .confirm-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 50px 20px;
        }

        .merchant-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            color: #777777;
            letter-spacing: 1px;
        }

        #provider-icon {
            width: 65px;
        }

        .total-amount {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            width: 100%;
            text-wrap: nowrap;
            margin-bottom: 15px;
        }

        .split-line {
            height: 0px;
            border: 1px solid #EAEAEA;
            width: 100%;
        }

        .payment-details, .merchant {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            text-wrap: wrap;
            margin-top: 20px;
        }

        #details-title {
            color: #777777;
        }

        .bottom-section {
            display: flex;
            flex-direction: column;
            margin-top: 150px;
            gap: 20px;
            padding: 20px;
        }

        .secure-transfer {
            display: flex;
            gap: 12px;
            color: #888888;
            font-size: 14px;
            letter-spacing: 1px;
            line-height: 20px;
        }

        .secure-transfer img {
            width: 30px;
            height: 30px;
        }

        .bottom-section button {
            padding: 10px;
            border: none;
            outline: none;
            background: #0064FF;
            color: #FFFFFF;
            font-weight: bold;
            border-radius: 20px;
            font-size: 14px;
        }

        .bottom-section button:hover {
            background: #0047BA;
        }
    </style>
</head>
<body>
    <main>
        <header>Confirm Payment</header>

        <div class="confirm-section">
            <div class="merchant-icon">
                <img id="provider-icon" src="../../Icon/tng.svg">
                <span id="phone-number">+60******1234</span>
            </div>
            <div class="total-amount">
                <div class="split-line"></div>
                <span>RM 9.20</span>
                <div class="split-line"></div>
            </div>
            <div class="payment-details">
                <span id="details-title">Payment Details</span>
                <span>Payment xxxxxxxxxxx:xxxxxxx</span>
            </div>
            <div class="merchant">
                <span id="details-title">Merchant</span>
                <span>TARUMT's Cafeteria</span>
            </div>
        </div>

        <div class="bottom-section">
            <div class="secure-transfer">
                <img src="../../Icon/shield.png">
                <span>As per regulations, your money is kept safe in a separate trust account and used only for transactions you authorise.</span>
            </div>
            <button id="confirm-button">Confirm</button>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../JS/script.js"></script>
    <script>
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const orderId = urlParams.get('oid'); // Changed from tid to oid
            const provider = urlParams.get('provider');

            const providerData = {
                tng: { name: "Touch'n Go eWallet", icon: "../../Icon/tng.svg", color: "#0047BA" },
                grabpay: { name: "GrabPay", icon: "../../Icon/grabpay.png", color: "#00B14F" },
                alipay: { name: "Alipay", icon: "../../Icon/alipay.png", color: "#1677FF" },
                boost: { name: "Boost", icon: "../../Icon/boosticon.png", color: "#EA0029" },
                shopeepay: { name: "ShopeePay", icon: "../../Icon/shopeepay.png", color: "#EE4D2D" }
            };

            // 1. Fetch details from backend using transactionId
            $.ajax({
                url: `../../Controller/AuthController.php?action=get_confirmation_details&oid=${orderId}`,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'success') {
                        const amount = parseFloat(response.amount || '0').toFixed(2);
                        $('.total-amount span').text('RM ' + amount);

                        if (provider && providerData[provider]) {
                            const data = providerData[provider];
                            $('header').css('background', data.color);
                            $('.bottom-section button').css('background', data.color);
                            $('#provider-icon').attr('src', data.icon);
                        }
                    } else {
                        $('.confirm-section').html(`<h1>Error</h1><p>${response.message}</p>`);
                        $('.bottom-section').hide();
                    }
                }
            });


            // 2. 確認按鈕點擊事件
            $('#confirm-button').on('click', function() {
                const $button = $(this);
                if ($button.prop('disabled')) return;

                const originalText = $button.text();
                $button.prop('disabled', true).text('Processing...');

                placeOrder(orderId);

                // 恢復按鈕狀態以防出錯
                setTimeout(() => {
                    if ($button.prop('disabled')) {
                        $button.prop('disabled', false).text(originalText);
                    }
                }, 5000);
            });

            // 3. 下單函數
            function placeOrder(oid) {
                if (!oid) {
                    displayToast("Invalid order details.", "error");
                    $('#confirm-button').prop('disabled', false).text('Confirm');
                    return;
                }
                $.ajax({
                    url: '../../Controller/AuthController.php',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'place_order',
                        order_id: oid, // Pass order_id to confirm
                    },
                    success: function(response) {
                        if (response.status === 'success' && response.order_id) {
                            const totalAmount = parseFloat($('.total-amount span').text().replace('RM ', ''));
                            const providerName = providerData[provider]?.name || 'E-Wallet';
                            const receiptUrl = `receipt.html?amount=${totalAmount}&orderId=${response.order_id}&method=${encodeURIComponent(providerName)}`;
                            window.location.href = receiptUrl;
                        } else {
                            displayToast(response.message || 'Failed to place order.', 'error');
                            $('#confirm-button').prop('disabled', false).text('Confirm');
                        }
                    },
                    error: function() {
                        displayToast('An error occurred while placing the order.', 'error');
                        $('#confirm-button').prop('disabled', false).text('Confirm');
                    }
                });
            }

            // 如果缺少必要參數，提示錯誤並返回
            if (!orderId || !provider) {
                $('.confirm-section').html('<h1>Invalid Payment Link</h1><p>Missing required information.</p>');
                $('.bottom-section').hide();
            }
        });
    </script>
</body>
</html>