<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../CSS/auth.css">
    <title>Receipt</title>
    <link rel="shortcut icon" href="../../Icon/logo.png">
</head>
<body>
    <main class="receipt-container">
        <div class="tarumt-cafeteria">
            <img src="../../Icon/logo.png">
            <h1>RECEIPT</h1>
            <h2>TARUMT's Cafeteria</h2>
        </div>
        <div class="divider-line"></div>
        <div class="order-info">
            <div class="info-row">
                <span>Order ID</span>
                <span id="order-id">Loading...</span>
            </div>
            <div class="info-row">
                <span>Date</span>
                <span id="order-date">Loading...</span>
            </div>
            <div class="info-row">
                <span>Time</span>
                <span id="order-time">Loading...</span>
            </div>
        </div>
        <div class="divider-line"></div>
        <div class="items-list" id="items-list"></div>
        <div class="divider-line"></div>
        <div class="total-list">
            <div class="total-row">
                <span>Subtotal</span>
                <span id="subtotal">RM 0.00</span>
            </div>
            <div class="total-row">
                <span>Service Tax (6%)</span>
                <span id="tax">RM 0.00</span>
            </div>
        </div>
        <div class="divider-line"></div>
        <div class="total-amount-row">
            <span>TOTAL</span>
            <span id="total-amount">RM 0.00</span>
        </div>
        <button id="back-button">Back to Home</button>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (orderId) {
                $.ajax({
                    url: `../../Controller/AuthController.php?action=get_order_details&oid=${orderId}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.status === 'success') {
                            const data = response.data;
                            // Replace space with 'T' to ensure consistent parsing as local time across browsers
                            const orderDate = new Date(data.Created_At.replace(' ', 'T'));

                            console.log("Created_At raw:", data.Created_At);
                            console.log("Parsed as Date:", orderDate.toString());

                            // Populate order info
                            $('#order-id').text(data.Order_ID);
                            $('#order-date').text(orderDate.toLocaleDateString('en-CA')); // YYYY-MM-DD
                            $('#order-time').text(orderDate.toLocaleTimeString('en-GB')); // HH:MM:SS

                            // Populate items
                            const itemsList = $('#items-list');
                            itemsList.empty();
                            let subtotal = 0;
                            data.items.forEach(item => {
                                const itemHtml = `
                                    <div class="items-row">
                                        <span>${item.Quantity}x ${item.Product_Name}</span>
                                        <span>RM ${parseFloat(item.Subtotal).toFixed(2)}</span>
                                    </div>
                                `;
                                itemsList.append(itemHtml);
                                subtotal += parseFloat(item.Subtotal);
                            });

                            // Populate totals
                            const tax = subtotal * 0.06;
                            const total = subtotal + tax;
                            $('#subtotal').text(`RM ${subtotal.toFixed(2)}`);
                            $('#tax').text(`RM ${tax.toFixed(2)}`);
                            $('#total-amount').text(`RM ${total.toFixed(2)}`);

                        } else {
                            $('.receipt-container').html(`<h1>Error</h1><p>${response.message}</p>`);
                        }
                    },
                    error: function() {
                        $('.receipt-container').html('<h1>Error</h1><p>Could not load receipt details.</p>');
                    }
                });
            } else {
                $('.receipt-container').html('<h1>Error</h1><p>No Order ID provided.</p>');
            }

            // --- Back Button Logic ---
            const fromPage = urlParams.get('from');
            const referrer = document.referrer;
            const backButton = $('#back-button');

            if (fromPage === 'history') {
                // Case 1: Coming from the order history page
                backButton.text('Back to History');
            } else if (referrer.includes('confirmation.html')) {
                // Case 2: Coming from a payment flow, hide the button
                backButton.hide();
            }

            // Add the click handler for the button
            backButton.on('click', function() {
                if (backButton.text() === 'Back to History') {
                    // If text is 'Back to History', go to history page
                    window.location.href = 'navigator.html?page=history';
                } else {
                    // Otherwise, go to home page
                    window.location.href = 'navigator.html?page=home';
                }
            });
        });
    </script>
</body>
</html>